#! /bin/sh
# Requires b3sum(1), git(1) for configuration, and rsync(1).
set -eux

config_file=${XDG_CONFIG_HOME:-$HOME/.config}/up/config.ini
host=$(git config --file "$config_file" up.host)
dest_dir=$(git config --file "$config_file" up.dir)
url=$(git config --file "$config_file" up.url)

exit_code=0
time=$(date +%s)

for file in "$@"; do
    if ! [ -f "$file" ]; then
        echo 'up: cannot access file:' "$file" >&2
        exit_code=1
        continue
    fi

    checksum=$(b3sum -l 2 "$file" | cut -d ' ' -f 1)
    subdir=$(printf '%x%s' "$time" "$checksum")

    if rsync --checksum --mkpath --progress --times "$file" "$host":"$dest_dir"/"$subdir"/"$file"; then
        echo "${url%/}/$subdir/$file"
    fi
done

exit "$exit_code"
