#! /bin/sh
# File upload script.
#
# Copyright (c) 2025 D. Bohdan
# License: MIT
#
# Requires git(1) for configuration, jq(1), rsync(1), and sha256sum(1).
set -eu

me=$(basename "$0")
config_file=${XDG_CONFIG_HOME:-$HOME/.config}/up/config

if ! [ -f "$config_file" ]; then
    echo "$me: config file not found at $config_file" >&2
    exit 1
fi
host=$(git config --file "$config_file" up.host)
dest_dir=$(git config --file "$config_file" up.dir)
url=$(git config --file "$config_file" up.url)

exit_code=0
file_urls=
random=$(dd if=/dev/random bs=64 count=1 2>/dev/null | sha256sum | cut -c -4)
subdir=$(printf '%x%s' "$(date +%s)" "$random")

for file in "$@"; do
    if ! [ -f "$file" ]; then
        echo "$me: bad file: $file" >&2
        exit_code=1
        continue
    fi

    basename=$(basename "$file")
    file_urls="$file_urls
${url%/}/$subdir/$(echo "$basename" | jq -R -r @uri)"
done

if [ "$exit_code" -ne 0 ]; then
    exit "$exit_code"
fi

rsync \
    --checksum \
    --mkpath \
    --progress \
    --times \
    "$@" \
    "$host:$dest_dir/$subdir/" &&
    echo "$file_urls"
